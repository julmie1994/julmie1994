<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ICAO VFR Trainer</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 2rem;
        background: #0b1020;
        color: #f4f6fb;
      }
      .panel {
        background: #151b2e;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        max-width: 900px;
      }
      .row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.35rem;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #2b3352;
        background: #0f1528;
        color: #f4f6fb;
      }
      button {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        border: none;
        background: #3f6ad8;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      pre {
        background: #0f1528;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
      }
      .muted {
        color: #b5bfdc;
      }
      .status {
        margin-top: 0.75rem;
        color: #ffd479;
      }
      .log {
        margin-top: 1rem;
        padding: 1rem;
        background: #0f1528;
        border-radius: 8px;
        min-height: 120px;
      }
      .log-entry {
        margin-bottom: 0.75rem;
      }
      .log-entry span {
        font-weight: 600;
      }
      .log-entry.atc span {
        color: #7dd3fc;
      }
      .log-entry.pilot span {
        color: #fca5a5;
      }
    </style>
  </head>
  <body>
    <div class="panel">
      <h1>ICAO VFR Trainer (Demo)</h1>
      <p class="muted">
        Voice-first UI scaffold. Record audio or enter a transcript to exercise
        the normalizer, parser, validator, and state machine.
      </p>

      <div class="row">
        <div style="flex: 1 1 240px">
          <label for="state">State</label>
          <select id="state">
            <option value="initial_call">initial_call</option>
            <option value="taxi_request">taxi_request</option>
            <option value="taxi_clearance">taxi_clearance</option>
            <option value="intermediate_hold">intermediate_hold</option>
            <option value="taxi_continue">taxi_continue</option>
            <option value="departure_instructions">departure_instructions</option>
            <option value="lineup_wait">lineup_wait</option>
            <option value="takeoff_clearance">takeoff_clearance</option>
            <option value="airborne_time">airborne_time</option>
            <option value="qnh_update">qnh_update</option>
            <option value="leave_sector">leave_sector</option>
            <option value="frequency_change">frequency_change</option>
          </select>
        </div>
        <div style="flex: 1 1 240px">
          <label for="scenario">Scenario</label>
          <input id="scenario" value="graz_vfr_sector_e" />
        </div>
      </div>

      <div style="margin-top: 1rem">
        <label for="text">Transcript</label>
        <textarea
          id="text"
          rows="4"
          placeholder="Graz Tower, OE-CRD, apron south, information Q received, request taxi"
        ></textarea>
      </div>

      <div class="row" style="margin-top: 1rem">
        <button id="record">Start Recording</button>
        <button id="stop" disabled>Stop Recording</button>
        <button id="send">Send Transcript</button>
        <button id="send-audio" disabled>Send Audio</button>
        <button id="clear">Clear</button>
      </div>

      <div class="status" id="status"></div>

      <h3>Response</h3>
      <pre id="output">{}</pre>

      <h3>Conversation</h3>
      <div id="log" class="log"></div>
    </div>

    <script>
      const sendButton = document.getElementById("send");
      const sendAudioButton = document.getElementById("send-audio");
      const clearButton = document.getElementById("clear");
      const recordButton = document.getElementById("record");
      const stopButton = document.getElementById("stop");
      const output = document.getElementById("output");
      const status = document.getElementById("status");
      const log = document.getElementById("log");
      let mediaRecorder = null;
      let audioChunks = [];

      function appendLog(role, text) {
        const entry = document.createElement("div");
        entry.className = `log-entry ${role}`;
        entry.innerHTML = `<span>${role.toUpperCase()}:</span> ${text}`;
        log.appendChild(entry);
      }

      function updateState(nextState) {
        const stateSelect = document.getElementById("state");
        if (nextState && stateSelect.value !== nextState) {
          stateSelect.value = nextState;
        }
      }

      async function sendPayload() {
        status.textContent = "Sending...";
        const payload = {
          text: document.getElementById("text").value,
          state: document.getElementById("state").value,
          scenario: document.getElementById("scenario").value,
        };

        try {
          const response = await fetch("/stt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          output.textContent = JSON.stringify(data, null, 2);
          if (payload.text.trim()) {
            appendLog("pilot", payload.text.trim());
          }
          if (data.atc_response?.text) {
            appendLog("atc", data.atc_response.text);
          }
          updateState(data.next_state);
          status.textContent = response.ok
            ? "OK"
            : `Error ${response.status}: ${data.detail || "unknown"}`;
        } catch (error) {
          status.textContent = `Request failed: ${error}`;
        }
      }

      async function sendAudio() {
        if (audioChunks.length === 0) {
          status.textContent = "No audio recorded yet.";
          return;
        }
        status.textContent = "Uploading audio...";
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "recording.webm");
        formData.append("state", document.getElementById("state").value);
        formData.append("scenario", document.getElementById("scenario").value);

        try {
          const response = await fetch("/stt/audio", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          output.textContent = JSON.stringify(data, null, 2);
          if (data.text) {
            appendLog("pilot", data.text);
          }
          if (data.atc_response?.text) {
            appendLog("atc", data.atc_response.text);
          }
          updateState(data.next_state);
          status.textContent = response.ok
            ? "OK"
            : `Error ${response.status}: ${data.detail || "unknown"}`;
        } catch (error) {
          status.textContent = `Upload failed: ${error}`;
        }
      }

      async function startRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };
          mediaRecorder.onstop = () => {
            sendAudioButton.disabled = audioChunks.length === 0;
            status.textContent = "Recording stopped.";
          };
          mediaRecorder.start();
          recordButton.disabled = true;
          stopButton.disabled = false;
          status.textContent = "Recording...";
        } catch (error) {
          status.textContent = `Microphone error: ${error}`;
        }
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          recordButton.disabled = false;
          stopButton.disabled = true;
        }
      }

      sendButton.addEventListener("click", sendPayload);
      sendAudioButton.addEventListener("click", sendAudio);
      recordButton.addEventListener("click", startRecording);
      stopButton.addEventListener("click", stopRecording);
      clearButton.addEventListener("click", () => {
        document.getElementById("text").value = "";
        output.textContent = "{}";
        status.textContent = "";
        audioChunks = [];
        sendAudioButton.disabled = true;
        log.innerHTML = "";
      });
    </script>
  </body>
</html>
